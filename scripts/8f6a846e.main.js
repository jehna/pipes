"use strict";function App(){var a=this;this.nodeCache=[],this.ioCache=[],this.listeners={refreshConnections:[]},setInterval(function(){a.save()},5e3)}App.prototype={},App.prototype.load=function(a){var b=this;"undefined"==typeof a&&(a=localStorage.getItem("state")),a||(a={nodes:[],connections:[]},a='{"nodes":[{"name":"Link","inputs":[],"outputs":[{"name":"Output","uuid":"df6ce7f8-9faf-4eba-ab1d-07dda5101767"}],"uuid":"cf78bc2d-be43-4b0a-84fc-be1aa7e730f2","type":"input.link","position":{"x":100,"y":100}},{"name":"Redirect","inputs":[{"name":"Input","uuid":"53eb848f-9d6e-428d-a3d7-8e4651a3022d"}],"outputs":[],"uuid":"861e9934-321e-4243-b441-8f446afc0dc2","type":"output.redirect","position":{"x":1098,"y":98}},{"name":"Session","inputs":[{"name":"Input","uuid":"216c8131-783a-4f88-9de6-eca21e255011"}],"outputs":[{"name":"Output","uuid":"f2610bf9-73c9-4964-af0c-782cad37f65a"}],"uuid":"6a1550fc-4dc7-4be3-92b5-60ba6e278075","type":"modifier.session","position":{"x":800,"y":71}},{"name":"DB Find","inputs":[{"name":"Input","uuid":"1d67b168-4556-45bc-9a00-5c7228239f2e"}],"outputs":[{"name":"Success","uuid":"2c1d9217-c86c-415a-a158-d15cab991cf4"},{"name":"Fail","uuid":"196ce114-c50a-4271-ba22-0e15960f40ab"}],"uuid":"4855c8f5-d8f8-4d19-a333-7e46cc228b3d","type":"db.find","position":{"x":380,"y":60}},{"name":"Redirect","inputs":[{"name":"Input","uuid":"dc6881cd-459f-474b-aedd-523d82e5692b"}],"outputs":[],"uuid":"65c811a5-6ffc-4248-84ed-1b036f1692b0","type":"output.redirect","position":{"x":695,"y":251}}],"connections":[{"from":"f2610bf9-73c9-4964-af0c-782cad37f65a","to":"53eb848f-9d6e-428d-a3d7-8e4651a3022d"},{"from":"df6ce7f8-9faf-4eba-ab1d-07dda5101767","to":"1d67b168-4556-45bc-9a00-5c7228239f2e"},{"from":"2c1d9217-c86c-415a-a158-d15cab991cf4","to":"216c8131-783a-4f88-9de6-eca21e255011"},{"from":"196ce114-c50a-4271-ba22-0e15960f40ab","to":"dc6881cd-459f-474b-aedd-523d82e5692b"}]}'),"string"==typeof a&&(a=JSON.parse(a)),this.data=a,this.data.nodes.forEach(function(a){b.refreshNode(a)}),b.refreshConnections()},App.prototype.refreshNode=function(a){var b=this,c=this.nodeCache[a.uuid],d=c?c.element:$("#"+a.uuid);d.length||(d=$($("#node-template").html()),d.attr("id",a.uuid),d.find("h1").text(a.name),a.outputs.forEach(function(a){var c=$("<div />").addClass("output").text(a.name).attr("id",a.uuid).appendTo(d);b.ioCache[a.uuid]={io:a,element:c,type:"output"}}),a.inputs.forEach(function(a){var c=$("<div />").addClass("input").text(a.name).attr("id",a.uuid).appendTo(d);b.ioCache[a.uuid]={io:a,element:c,type:"input"}}),$("#base").append(d),this.nodeCache[a.uuid]={node:a,element:d}),d.css({transform:"translate("+a.position.x+"px,"+a.position.y+"px)"})},App.prototype.insertNode=function(a){var b=App.getNodeType(a),c=$.extend(b,{uuid:uuid.v4(),type:a,position:{x:100,y:100}});c.inputs=c.inputs.map(function(a){return a.uuid=uuid.v4(),a}),c.outputs=c.outputs.map(function(a){return a.uuid=uuid.v4(),a}),this.data.nodes.push(c),this.refreshNode(c)},App.prototype.insertConnection=function(a,b){var c={from:a.uuid,to:b.uuid};this.data.connections.push(c),this.refreshConnections()},App.prototype.refreshConnections=function(){this.listeners.refreshConnections.forEach(function(a){a()})},App.prototype.save=function(){localStorage.setItem("state",JSON.stringify(this.data))},App.prototype.getNodeById=function(a){return this.nodeCache[a].node},App.prototype.getIOById=function(a){return this.getCachedIOById(a).io},App.prototype.getCachedIOById=function(a){return this.ioCache[a]},App.nodeTypes={input:{link:{name:"Link",inputs:[],outputs:[{name:"Output"}]}},output:{redirect:{name:"Redirect",inputs:[{name:"Input"}],outputs:[]}},modifier:{session:{name:"Session",inputs:[{name:"Input"}],outputs:[{name:"Output"}]}},db:{find:{name:"DB Find",inputs:[{name:"Input"}],outputs:[{name:"Success"},{name:"Fail"}]}},other:{settings:{name:"Settings",inputs:[],outputs:[]}}},App.getNodeType=function(a){for(var b,c=a.split("."),d=App.nodeTypes;(b=c.shift())&&(d=d[b]););if(!d||!d.name)throw new Error("No such node type: "+a);return d},window.app=new App,$(function(){app.load()}),$(function(){$("#add-input").click(function(){app.insertNode("input.link")}),$("#add-output").click(function(){app.insertNode("output.redirect")}),$("#add-modifier").click(function(){app.insertNode("modifier.session")}),$("#add-db").click(function(){app.insertNode("db.find")}),$("#add-other").click(function(){app.insertNode("other.settings")})}),$(function(){var a,b,c=$("body"),d=function(c){c.preventDefault();var d={x:c.pageX-a.eX,y:c.pageY-a.eY};b.position={x:d.x+a.tX,y:d.y+a.tY},app.refreshNode(b),app.refreshConnections()};$("#base").on("mousedown mouseup",".card",function(e){e.preventDefault();var f=$(this);b=app.getNodeById(f.attr("id")),"mousedown"===e.type&&(a={eX:e.pageX,eY:e.pageY,tX:b.position.x,tY:b.position.y},c.on("mousemove",d)),"mouseup"===e.type&&c.off("mousemove",d)})}),$(function(){function a(a){function b(b){return function(){var c=Array.prototype.slice.apply(arguments).map(function(a){return"number"==typeof a?2*a:a});CanvasRenderingContext2D.prototype[b].apply(a,c)}}function c(b){return function(c){"number"==typeof c?a[b]=2*c:a[b]=c}}function d(b){return function(){var c=a[b];return"number"==typeof c?2*c:c}}for(var e in a)"function"==typeof a[e]?this[e]=b(e):(this.__defineSetter__(e,c(e)),this.__defineGetter__(e,d(e)))}function b(a,b){return{x:a.offset().left+(b===r?-20:a.width()+20),y:a.offset().top+10}}function c(){n.attr("width",2*m.width()),n.attr("height",2*m.height()),e()}function d(a,b){var c={x:b.x-a.x,y:b.y-a.y};p.beginPath(),p.lineWidth=6,p.strokeStyle="#ffcc00",p.moveTo(a.x,a.y);var d={x:a.x+.5*c.x,y:a.y},e={x:a.x+.5*c.x,y:b.y},f=50;c.x<f&&(d.x=a.x+f/2+(c.x-f)*-.4,e.x=b.x-f/2+.4*(c.x-f)),p.bezierCurveTo(d.x,d.y,e.x,e.y,b.x,b.y),p.stroke()}function e(){p.clearRect(0,0,o.width/2,o.height/2),app.data.connections.forEach(function(a){var c=app.getCachedIOById(a.from).element,e=app.getCachedIOById(a.to).element,f=b(c,s),g=b(e,r);d(f,g)})}var f,g,h,i,j,k,l,m=$("body"),n=$("#c"),o=n[0],p=new a(o.getContext("2d"));p.imageSmoothingEnabled=!0,$(window).on("resize",c);var q=function(a){var c={x:f.x,y:f.y},m={x:a.pageX,y:a.pageY};if(g){var n=c;c=m,m=n}i=!1,$(".highlight-snap").removeClass("highlight-snap");var o=g?c:m;if(h.each(function(){var a=b($(this),g?s:r);Math.abs(a.x-o.x)+Math.abs(a.y-o.y)<60&&(i=$(this))}),i){i.addClass("highlight-snap");var p=b(i,g?s:r);g?(c=p,j=app.getCachedIOById(i.attr("id"))):(m=p,k=app.getCachedIOById(i.attr("id")))}window.cancelAnimationFrame(l),l=window.requestAnimationFrame(function(){e(),d(c,m)})},r=!0,s=!1;$("#base").on("mousedown",".input, .output",function(a){a.preventDefault(),a.stopPropagation();var c=$(this),d=c.is(".input")?r:s,i=app.getCachedIOById(c.attr("id"));g=d===r,g?k=i:j=i,f=b(c,d);var l=d===r?".output":".input",n=c.closest(".card").find(l);h=$(l).not(n);var o=function(){m.off("mousemove",q),m.off("mouseup",o),$(".highlight-snap").removeClass("highlight-snap"),j&&k&&app.insertConnection(j.io,k.io),j=null,k=null,e()};m.on("mousemove",q),m.on("mouseup",o)}),app.listeners.refreshConnections.push(e),c()});